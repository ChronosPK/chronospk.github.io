---
title: Defense techniques
categories:
  - Pentesting
  - Attack-Defense
tags:
  - Pentesting
  - Attack-Defense
toc: true
---

---
Defense techniques used in Attack - Defense CTF competitions, also known Red team - Blue team.
Applicable in KOTH (King of the Hill) and _partly_ in real life.

---
<!-- more -->

<br>

## Protection systems
Install security updates
```bash
sudo apt-get update
sudo apt-get upgrade
```
Enable auditing with `auditd`
```bash
sudo apt-get install auditd
sudo systemctl enable auditd
```
Use Logwatch (or Logcheck) to monitor log files for suspicious activity
```bash logwatch - install and configure
sudo apt-get install logwatch
sudo nano /usr/share/logwatch/default.conf/logwatch.con
```
```bash logwatch - monitor SSH login attempts
LogFile = /var/log/auth.log
*Remove = root
*Remove = backup
*Remove = mail
*OnlyHosts = 192.168.1.0/24
*ApplyhttpDate
*ApplyStdDate
*Apply = /usr/share/logwatch/scripts/shared/apply-uudecode
*Apply = /usr/share/logwatch/scripts/shared/apply-mailto
*NoDetail = /etc/logwatch/conf/logwatch.conf
```
```bash logwatch - run and generate a report
sudo logwatch
```
Use a file integrity monitoring tool
```bash tripwire
sudo apt-get install tripwire
sudo tripwire --init    # initialize the tripwire database
sudo tripwire --check   # check for changes
```
Use an IDS/IPS
```bash snort
sudo apt-get install snort
sudo systemctl start snort
sudo tail -f /var/log/snort/alert
```

<br>

## Firewall
Configure `iptables`
```bash
sudo iptables -A INPUT -p tcp --dport 22222 -j ACCEPT  # Allows SSH traffic - change SSH port below
sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT # Allows established connections
sudo iptables -A INPUT -j DROP # Deny all other traffic
```

<br>

## SSH
Improve SSH security
```bash modify SSH config
sudo nano /etc/ssh/sshd_config
```
```bash uncomment or modify the following lines
Port 22222
PasswordAuthentication no
ChallengeResponseAuthentication no
PubkeyAuthentication yes
PermitRootLogin no
```
```bash
sudo systemctl restart sshd
```

View SSH logs
```bash
sudo journalctl -u ssh
```

Accept only private key authentication
```bash locally - generate and send public key
ssh-keygen -t rsa
ssh-copy-id -i ~/.ssh/id_rsa.pub user@target_ip
```
```bash remote - uncomment lines in "/etc/ssh/sshd_config"
PasswordAuthentication no
ChallengeResponseAuthentication no
```

Set up Fail2ban
```bash
sudo apt-get install fail2ban
nano /etc/fail2ban/jail.local
```
```conf /etc/fail2ban/jail.local
[sshd]
enabled = true
port = 22222
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 86400
```

<br>

## System config
Disable unused network protocols
```bash
sudo nano /etc/sysctl.conf
```
```conf /etc/sysctl.conf
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
```
Disable unnecessary services
```bash
systemctl list-unit-files --state=enabled
sudo systemctl disable $service_name
```

<br>

## Users

Prevent users from seeing processes that do not belong to them
```bash
sudo mount -o remount,rw,hidepid=2 /proc
```
```bash create a group of users that bypass this restriction
proc /proc proc defaults,hidepid=2,gid=admin 0 0 
```

Kick a user off your machine
```bash first method
# replace $user
# replace $tty with terminal name in `who` output (ex. `pts/2`) 
echo "Goodbye, kiddo!" | write $user $tty && sleep 10 && killall -u $user -HUP
```
```bash second method
# view who is logged in and the tty pid
who -u
# mock them before you kick them out
(echo "And now... you are gone" | write $user $tty) && sleep 10
# kill the tty pid
kill -9 $pid
```

Remove ability to view output for commands
```bash
exec >/dev/null
```
```bash enable output
exec >/dev/tty
```

<br>

## Files
View recently modified files
```bash created or modified in the last 5 days
find / -mtime -5 -o -ctime -5 2>/dev/null
```

<br>

---
---